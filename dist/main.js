(()=>{"use strict";const e=(e,t,o)=>{const r=[];if(r[0]=e,"vertical"===o)for(let e=1;e<t;e++)r[e]=r[e-1]+10;else for(let e=1;e<t;e++)r[e]=r[e-1]+1;return r};function t(t){if(t<2||t>5)throw new Error("Invalid ship length, must be between 2 and 5 inclusive");let o="vertical";const r=[],a=[];return{length:t,orientation:o,hit:e=>{a.push(e)},isSunk:()=>a.length===t,setPosition:(o,a)=>{r.length=0,e(o,t,a).forEach((e=>{r.push(e)}))},position:r,hits:a,resetShip:()=>{r.length=0,o="vertical",a.length=0}}}function o(o){const r=function(){const t=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99],o=[],r=[],a=[],n=()=>r,l=(t,o,r,a=!1)=>{let l=!0;const i=e(t,o,r);if(i[o-1]>=100||i[o-1]%10<t%10)return!1;const c=[];return n().forEach((e=>{c.push(e.position)})),l=a?!c.flat().some((e=>i.slice(1).includes(e))):!c.flat().some((e=>i.slice(0).includes(e))),l};return{getMissedAttacks:()=>o,getCurrentShips:n,placeShip:(e,t)=>{if(!l(e,t.length,t.orientation))throw new Error("Error: invalid ship position");r.some((e=>e===t))||r.push(t),t.setPosition(e,t.orientation)},isValidPosition:l,rotateShip:e=>{if("vertical"===e.orientation){if(l(e.position[0],e.length,"horizontal",!0))return e.setPosition(e.position[0],"horizontal"),void(e.orientation="horizontal");throw new Error("Error: invalid rotation")}if(!l(e.position[0],e.length,"vertical",!0))throw new Error("Error: invalid rotation");e.setPosition(e.position[0],"vertical"),e.orientation="vertical"},receiveAttack:e=>{if(a.includes(e))throw new Error("Error: coordinate already attacked");const t=[],l=n();for(let o=0;o<r.length;o++)if(l[o].position.includes(e))return l[o].hit(e),t.push(l[o]),a.push(e),t;return a.push(e),o.push(e),t},remainingShips:()=>{let e=0;return n().forEach((t=>{t.isSunk()||(e+=1)})),e},getAllAttackedCoordinates:()=>a,getRemainingFreeCells:()=>t.filter((e=>!a.includes(e))),resetBoard:()=>{o.length=0,r.length=0,a.length=0}}}();let a;const n=[t(5),t(4),t(3),t(3),t(2)];return{name:o,board:r,attack:(e,t)=>{e.receiveAttack(t)},ships:n,allocateDOMBoard:e=>{a=e},getDOMBoard:()=>a,activateDOMBoard:()=>{a.classList.add("board__table--active")},deactivateDOMBoard:()=>{a.classList.remove("board__table--active")},resetAllShips:function(){n.forEach((e=>{e.resetShip()}))},allShipsPlaced:()=>{for(let e=0;e<n.length;e++)if(0===n[e].position.length)return!1;return!0},getName:e=>1===e?document.querySelector(".name-one").textContent:document.querySelector(".name-two").textContent,placeAIShips:function(){const e=["vertical","horizontal"];for(let t=0;t<5;t++){const o=n[t],a=e[Math.floor(2*Math.random())];o.orientation=a;let l=Math.floor(100*Math.random());for(;!r.isValidPosition(l,o.length,a,!1);)l=Math.floor(100*Math.random());r.placeShip(l,o)}}}}function r(e,t){const o=document.querySelector(".shipyard"),r=document.createElement("table");r.classList.add("ship"),r.setAttribute("draggable","true"),r.dataset.id=t;for(let t=0;t<e;t++){const e=document.createElement("tr");e.classList.add("ship-row");const o=document.createElement("td");o.classList.add("ship-cell"),e.appendChild(o),r.appendChild(e),r.dataset.length=t+1,r.dataset.orientation="vertical"}o.appendChild(r)}function a(){r(5,0),r(4,1),r(3,2),r(3,3),r(2,4)}function n(e,t){document.querySelectorAll(`.board__table-${t} .board__cell`).forEach((e=>e.classList.remove("board__cell--ship"))),e.board.getCurrentShips().forEach((e=>function(e,t){t.position.forEach((t=>{document.querySelector(`.board__table-${e} [data-coordinate='${t}']`).classList.add("board__cell--ship")}))}(t,e))),document.querySelectorAll(".ship").forEach((e=>e.remove()))}function l(e,t){t?e.classList.add("board__cell--hit"):e.classList.add("board__cell--miss")}function i(e,t){e.classList.add("board--hidden"),t.classList.remove("board--hidden")}const c=[1,2,3,4,5,6,7,8],d=[91,92,93,94,95,96,97,98],s=[19,29,39,49,59,69,79,89],u=[10,20,30,40,50,60,70,80];function h(e){return Math.abs(e[0]-e[1])>1?"vertical":"horizontal"}function m(e){document.querySelectorAll(".ship").forEach((t=>{t.addEventListener("click",(t=>{!function(e,t){const o=e.target.parentNode.parentNode;if(o.classList.contains("ship--placed"))try{t.board.rotateShip(t.ships[o.dataset.id]),o.classList.toggle("ship--horizontal"),"vertical"===o.dataset.orientation?o.dataset.orientation="horizontal":o.dataset.orientation="vertical"}catch(e){o.classList.add("ship--error"),setTimeout((()=>o.classList.remove("ship--error")),100)}}(t,e)}))}))}function p(){return!0===document.querySelector("#one-player").checked?1:2}function b(e){const t=document.querySelectorAll(".ship"),o=[...document.querySelectorAll(".board__cell")].filter((t=>e.getDOMBoard().contains(t))),r=document.querySelector(".shipyard");let n=null,l=null,i=null,c=null;const d=document.querySelector(".board--active");let s=parseInt(d.dataset.id);function u(){n=parseInt(this.dataset.length),l=this.dataset.orientation,i=this.dataset.id,c=this}function h(){n=null,l=null,i=null,c=null}function m(e){e.preventDefault()}function b(){e.board.isValidPosition(parseInt(this.dataset.coordinate),n,l)&&(e.board.placeShip(parseInt(this.dataset.coordinate),e.ships[i]),c.classList.add("ship--placed"),this.appendChild(c))}function y(){window.removeEventListener("dragend",S),document.querySelector(".board-one").classList.add("board--hidden"),document.querySelector(".board-one").classList.remove("board--active"),document.querySelector(".board-two").classList.remove("board--hidden"),document.querySelector(".board-two").classList.add("board--active"),a(),s=2;const e=new Event("boardswitched");window.dispatchEvent(e),document.querySelector('.board__ready[data-id="1"]').remove(),document.querySelector(".play-btn").classList.add("hidden")}function v(){r.remove(),s=1;const e=new Event("begintwoplayer");window.dispatchEvent(e),document.querySelector('.board__ready[data-id="2"]').remove(),document.querySelector(".play-btn").classList.add("hidden")}function S(){console.log(e.allShipsPlaced()),e.allShipsPlaced()&&2===p()?1===s?(document.querySelector('.board__ready[data-id="1"]').classList.remove("hidden"),document.querySelector('.board__ready[data-id="1"]').addEventListener("click",y)):(document.querySelector('.board__ready[data-id="2"]').classList.remove("hidden"),document.querySelector('.board__ready[data-id="2"]').textContent="Begin game",document.querySelector('.board__ready[data-id="2"]').addEventListener("click",v)):document.querySelector(".error").textContent=""}t.forEach((e=>{e.addEventListener("dragstart",u),e.addEventListener("dragend",h)})),o.forEach((e=>{e.addEventListener("dragover",m),e.addEventListener("dragenter",b)})),window.addEventListener("dragend",S)}const y=document.querySelector(".play-btn"),v=document.querySelector(".game-status"),S=document.querySelector(".error");v.textContent="Waiting for start";const _=function(){const e=function(e,t){const r=o(e),a=o(t);let n=0;const m=()=>{0===n?n+=1:n=0},p=()=>n,b=()=>{n=0},y=[r,a];let v=y[n];const S=()=>{v=y[p()]},_=()=>{0===p()?(r.deactivateDOMBoard(),a.activateDOMBoard(),document.querySelector(".board__title-1").classList.add("board__title--active"),document.querySelector(".board__title-2").classList.remove("board__title--active")):(r.activateDOMBoard(),a.deactivateDOMBoard(),document.querySelector(".board__title-2").classList.add("board__title--active"),document.querySelector(".board__title-1").classList.remove("board__title--active"))},g=()=>{0===p()?(document.querySelector(".board__title-1").classList.add("board__title--active"),document.querySelector(".board__title-2").classList.remove("board__title--active")):(document.querySelector(".board__title-2").classList.add("board__title--active"),document.querySelector(".board__title-1").classList.remove("board__title--active"))},f=()=>{m(),S(),_(),g()},q=e=>0===e.board.remainingShips(),L=()=>{b(),r.deactivateDOMBoard(),a.deactivateDOMBoard(),document.querySelector(".game-status").textContent=`Game over, ${v.name} wins!`,document.querySelector(".reset-btn").classList.remove("hidden")},w=()=>{const e=r.board.getRemainingFreeCells();return e[Math.floor(Math.random()*e.length)]},E=(e,t=null)=>{let o;const a=parseInt(e);if("vertical"===t){if(o=function(e){let t=[];switch(!0){case 0===e:case 9===e:case 90===e:case 99===e:t="none";break;case u.includes(e):case s.includes(e):t=[e-10,e+10];break;case c.includes(e):case d.includes(e):t="none";break;default:t=[e-10,e+10]}return t}(a),"none"===o)return}else if("horizontal"===t){if(o=function(e){let t=[];switch(!0){case 0===e:case 9===e:case 90===e:case 99===e:t="none";break;case c.includes(e):case d.includes(e):t=[e-1,e+1];break;case u.includes(e):case s.includes(e):t="none";break;default:t=[e-1,e+1]}return t}(a),"none"===o)return}else o=function(e){let t=[];switch(!0){case 0===e:t=[e+1,e+10];break;case 9===e:t=[e-1,e+10];break;case 90===e:t=[e+1,e-10];break;case 99===e:t=[e-1,e-10];break;case u.includes(e):t=[e+1,e-10,e+10];break;case s.includes(e):t=[e-1,e-10,e+10];break;case c.includes(e):t=[e-1,e+1,e+10];break;case d.includes(e):t=[e-1,e+1,e-10];break;default:t=[e-1,e+1,e-10,e+10]}return t}(a);const n=function(e,t){return e.filter((e=>!t.includes(e)))}(o,r.board.getAllAttackedCoordinates());return n[Math.floor(Math.random()*n.length)]},k=(e,t)=>new Promise((o=>{const a=t.board.receiveAttack(parseInt(e.target.dataset.coordinate));0===a.length?(l(e.target,!1),document.querySelector(".game-status").textContent="The battle is on!"):(l(e.target,!0),a[0].isSunk()?document.querySelector(".game-status").textContent=t===r?`You sunk one of ${t.getName(2)}'s ships!`:`You sunk one of ${t.getName(1)}'s ships!`:document.querySelector(".game-status").textContent="The battle is on!"),o()}));function C(){let e=w(),t=[];const o=[];let n=null;document.querySelector(".board__table-2").addEventListener("click",(i=>{i.target.parentNode.parentNode.parentNode.classList.contains("board__table--active")&&k(i,a).then((()=>{q(a)?L():f()})).then((()=>{let a;0!==t.length?o.length>1?"horizontal"===h(o)?(a=E(e,"horizontal"),void 0===a&&(a=E(o[0],"horizontal"))):(a=E(e,"vertical"),void 0===a&&(a=E(o[0],"vertical"))):a=E(e):0===t.length&&0!==o.length?o.length>1?"horizontal"===h(o)?(a=E(o[o.length-1],"horizontal"),void 0===a&&(a=E(o[0],"horizontal"))):(a=E(o[o.length-1],"vertical"),void 0===a&&(a=E(o[0],"vertical"))):(a=E(o[o.length-1]),void 0===a&&(a=E(o[0]))):a=w(),e=a,t=r.board.receiveAttack(parseInt(a)),null!==n&&0!==t.length&&t[0]!==n&&([n]=t,o.length=0),0!==t.length&&([n]=t),setTimeout((()=>{0===t.length?l(document.querySelector(`.board__table-1 [data-coordinate='${a}']`),!1):(l(document.querySelector(`.board__table-1 [data-coordinate='${a}']`),!0),t[0].isSunk()?(t.length=0,o.length=0,n=null):o.push(a)),q(r)?L():f()}),500)})).catch((e=>console.log(e)))}))}const M=(e,t)=>{e.target.parentNode.parentNode.parentNode.classList.contains("board__table--active")&&k(e,t).then((()=>{q(t)?L():(f(),t===r?setTimeout((()=>i(document.querySelector(".board-one"),document.querySelector(".board-two"))),1e3):setTimeout((()=>i(document.querySelector(".board-two"),document.querySelector(".board-one"))),1e3))})).catch((e=>console.log(e)))};return{playerOne:r,playerTwo:a,currentTurn:p,changeTurn:m,resetTurn:b,gameStartOnePlayer:()=>{a.placeAIShips(),b(),S(),_(),g(),C()},gameStartTwoPlayer:()=>{b(),S(),_(),g(),document.querySelector(".board__table-1").addEventListener("click",(e=>{M(e,r)})),document.querySelector(".board__table-2").addEventListener("click",(e=>{M(e,a)}))},changeCurrentPlayer:S,turnComplete:f,onePlayerGameLoop:C}}("Player 1","Player 2");return document.querySelector(".reset-btn").classList.add("hidden"),e.playerOne.board.resetBoard(),e.playerTwo.board.resetBoard(),e.playerOne.allocateDOMBoard(document.querySelector(".board__table-1")),e.playerTwo.allocateDOMBoard(document.querySelector(".board__table-2")),e}();y.addEventListener("click",(()=>{if(1===p()){if(!_.playerOne.allShipsPlaced())throw S.textContent="All ships must be placed first!",new Error("Not all ships placed");document.querySelectorAll(".board__cell").forEach((e=>e.classList.add("board__cell--active"))),_.gameStartOnePlayer(),n(_.playerOne,1),document.querySelector(".play-btn").classList.add("hidden"),document.querySelector(".restart-btn").classList.remove("hidden"),document.querySelector(".shipyard").remove(),v.textContent="The battle is on!"}else if(!_.playerTwo.allShipsPlaced()||!_.playerOne.allShipsPlaced())throw S.textContent="All ships must be placed first!",new Error("Not all ships placed")})),a(),1===p()&&(b(_.playerOne),m(_.playerOne)),window.addEventListener("boardswitched",(()=>{b(_.playerTwo),m(_.playerTwo)})),window.addEventListener("begintwoplayer",(()=>{document.querySelectorAll(".board__cell").forEach((e=>e.classList.add("board__cell--active"))),_.gameStartTwoPlayer(),n(_.playerOne,1),n(_.playerTwo,2)})),document.querySelector(".num-players__btn").addEventListener("click",(()=>{document.querySelector(".modal").style.display="none",1===p()?document.querySelector(".board-two").classList.remove("board--hidden"):document.querySelector(".board-two").classList.add("board--hidden")})),document.querySelector(".name-one").addEventListener("input",(e=>{_.playerTwo.name=e.target.textContent})),document.querySelector(".name-two").addEventListener("input",(e=>{_.playerTwo.name=e.target.textContent})),document.querySelector(".restart-btn").addEventListener("click",(()=>{window.location.reload()})),document.querySelector(".reset-btn").addEventListener("click",(()=>{window.location.reload()}))})();