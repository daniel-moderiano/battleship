(()=>{"use strict";const e=(e,t,r)=>{const a=[];if(a[0]=e,"vertical"===r)for(let e=1;e<t;e++)a[e]=a[e-1]+10;else for(let e=1;e<t;e++)a[e]=a[e-1]+1;return a};function t(t){if(t<2||t>5)throw new Error("Invalid ship length, must be between 2 and 5 inclusive");let r="vertical";const a=[],o=[];return{length:t,orientation:r,hit:e=>{o.push(e)},isSunk:()=>o.length===t,setPosition:(r,o)=>{a.length=0,e(r,t,o).forEach((e=>{a.push(e)}))},position:a,hits:o,resetShip:()=>{a.length=0,r="vertical",o.length=0}}}function r(r){const a=function(){const t=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99],r=[],a=[],o=[],n=()=>a,l=(t,r,a,o=!1)=>{let l=!0;const i=e(t,r,a);if(i[r-1]>=100||i[r-1]%10<t%10)return!1;const c=[];return n().forEach((e=>{c.push(e.position)})),l=o?!c.flat().some((e=>i.slice(1).includes(e))):!c.flat().some((e=>i.slice(0).includes(e))),l};return{getMissedAttacks:()=>r,getCurrentShips:n,placeShip:(e,t)=>{if(!l(e,t.length,t.orientation))throw new Error("Error: invalid ship position");a.some((e=>e===t))||a.push(t),t.setPosition(e,t.orientation)},isValidPosition:l,rotateShip:e=>{if("vertical"===e.orientation){if(l(e.position[0],e.length,"horizontal",!0))return e.setPosition(e.position[0],"horizontal"),void(e.orientation="horizontal");throw new Error("Error: invalid rotation")}if(!l(e.position[0],e.length,"vertical",!0))throw new Error("Error: invalid rotation");e.setPosition(e.position[0],"vertical"),e.orientation="vertical"},receiveAttack:e=>{if(o.includes(e))throw new Error("Error: coordinate already attacked");const t=[],l=n();for(let r=0;r<a.length;r++)if(l[r].position.includes(e))return l[r].hit(e),t.push(l[r]),o.push(e),t;return o.push(e),r.push(e),t},remainingShips:()=>{let e=0;return n().forEach((t=>{t.isSunk()||(e+=1)})),e},getAllAttackedCoordinates:()=>o,getRemainingFreeCells:()=>t.filter((e=>!o.includes(e))),resetBoard:()=>{r.length=0,a.length=0,o.length=0}}}();let o;const n=[t(5),t(4),t(3),t(3),t(2)];return{name:r,board:a,attack:(e,t)=>{e.receiveAttack(t)},ships:n,allocateDOMBoard:e=>{o=e},getDOMBoard:()=>o,activateDOMBoard:()=>{o.classList.add("board__table--active")},deactivateDOMBoard:()=>{o.classList.remove("board__table--active")},resetAllShips:function(){n.forEach((e=>{e.resetShip()}))},allShipsPlaced:()=>{for(let e=0;e<n.length;e++)if(0===n[e].position.length)return!1;return!0},getName:()=>document.querySelector(".name-one").textContent,placeAIShips:function(){const e=["vertical","horizontal"];for(let t=0;t<5;t++){const r=n[t],o=e[Math.floor(2*Math.random())];r.orientation=o;let l=Math.floor(100*Math.random());for(;!a.isValidPosition(l,r.length,o,!1);)l=Math.floor(100*Math.random());a.placeShip(l,r)}}}}function a(e,t){const r=document.querySelector(".shipyard"),a=document.createElement("table");a.classList.add("ship"),a.setAttribute("draggable","true"),a.dataset.id=t;for(let t=0;t<e;t++){const e=document.createElement("tr");e.classList.add("ship-row");const r=document.createElement("td");r.classList.add("ship-cell"),e.appendChild(r),a.appendChild(e),a.dataset.length=t+1,a.dataset.orientation="vertical"}r.appendChild(a)}function o(){a(5,0),a(4,1),a(3,2),a(3,3),a(2,4)}function n(e,t){document.querySelectorAll(`.board__table-${t} .board__cell`).forEach((e=>e.classList.remove("board__cell--ship"))),e.board.getCurrentShips().forEach((e=>function(e,t){t.position.forEach((t=>{document.querySelector(`.board__table-${e} [data-coordinate='${t}']`).classList.add("board__cell--ship")}))}(t,e))),document.querySelectorAll(".ship").forEach((e=>e.remove()))}function l(e,t){t?e.classList.add("board__cell--hit"):e.classList.add("board__cell--miss")}function i(e,t){e.classList.add("board--hidden"),t.classList.remove("board--hidden")}const c=[1,2,3,4,5,6,7,8],d=[91,92,93,94,95,96,97,98],s=[19,29,39,49,59,69,79,89],u=[10,20,30,40,50,60,70,80];function h(e){return Math.abs(e[0]-e[1])>1?"vertical":"horizontal"}function m(e){document.querySelectorAll(".ship").forEach((t=>{t.addEventListener("click",(t=>{!function(e,t){const r=e.target.parentNode.parentNode;if(r.classList.contains("ship--placed"))try{t.board.rotateShip(t.ships[r.dataset.id]),r.classList.toggle("ship--horizontal"),"vertical"===r.dataset.orientation?r.dataset.orientation="horizontal":r.dataset.orientation="vertical"}catch(e){r.classList.add("ship--error"),setTimeout((()=>r.classList.remove("ship--error")),100)}}(t,e)}))}))}function p(){return!0===document.querySelector("#one-player").checked?1:2}function b(e){const t=document.querySelectorAll(".ship"),r=[...document.querySelectorAll(".board__cell")].filter((t=>e.getDOMBoard().contains(t))),a=document.querySelector(".shipyard");let n=null,l=null,i=null,c=null;const d=document.querySelector(".board--active");let s=parseInt(d.dataset.id);function u(){n=parseInt(this.dataset.length),l=this.dataset.orientation,i=this.dataset.id,c=this}function h(){n=null,l=null,i=null,c=null}function m(e){e.preventDefault()}function b(){e.board.isValidPosition(parseInt(this.dataset.coordinate),n,l)&&(e.board.placeShip(parseInt(this.dataset.coordinate),e.ships[i]),c.classList.add("ship--placed"),this.appendChild(c))}function y(){window.removeEventListener("dragend",g),document.querySelector(".board-one").classList.add("board--hidden"),document.querySelector(".board-one").classList.remove("board--active"),document.querySelector(".board-two").classList.remove("board--hidden"),document.querySelector(".board-two").classList.add("board--active"),o(),s=2;const e=new Event("boardswitched");window.dispatchEvent(e),document.querySelector('.board__ready[data-id="1"]').remove(),document.querySelector(".play-btn").classList.add("hidden")}function v(){a.remove(),s=1;const e=new Event("begintwoplayer");window.dispatchEvent(e),document.querySelector('.board__ready[data-id="2"]').remove(),document.querySelector(".play-btn").classList.add("hidden")}function g(){console.log(e.allShipsPlaced()),e.allShipsPlaced()&&2===p()?1===s?(document.querySelector('.board__ready[data-id="1"]').classList.remove("hidden"),document.querySelector('.board__ready[data-id="1"]').addEventListener("click",y)):(document.querySelector('.board__ready[data-id="2"]').classList.remove("hidden"),document.querySelector('.board__ready[data-id="2"]').textContent="Begin game",document.querySelector('.board__ready[data-id="2"]').addEventListener("click",v)):document.querySelector(".error").textContent=""}t.forEach((e=>{e.addEventListener("dragstart",u),e.addEventListener("dragend",h)})),r.forEach((e=>{e.addEventListener("dragover",m),e.addEventListener("dragenter",b)})),window.addEventListener("dragend",g)}const y=document.querySelector(".play-btn"),v=document.querySelector(".game-status"),g=document.querySelector(".error");v.textContent="Waiting for start";const _=function(){const e=function(e,t){const a=r(e),o=r(t);let n=0;const m=()=>{0===n?n+=1:n=0},p=()=>n,b=()=>{n=0},y=[a,o];let v=y[n];const g=()=>{v=y[p()]},_=()=>{0===p()?(a.deactivateDOMBoard(),o.activateDOMBoard(),document.querySelector(".board__title-1").classList.add("board__title--active"),document.querySelector(".board__title-2").classList.remove("board__title--active")):(a.activateDOMBoard(),o.deactivateDOMBoard(),document.querySelector(".board__title-2").classList.add("board__title--active"),document.querySelector(".board__title-1").classList.remove("board__title--active"))},S=()=>{0===p()?(document.querySelector(".board__title-1").classList.add("board__title--active"),document.querySelector(".board__title-2").classList.remove("board__title--active")):(document.querySelector(".board__title-2").classList.add("board__title--active"),document.querySelector(".board__title-1").classList.remove("board__title--active"))},f=()=>{m(),g(),_(),S()},w=e=>0===e.board.remainingShips(),q=()=>{b(),a.deactivateDOMBoard(),o.deactivateDOMBoard(),document.querySelector(".game-status").textContent=`Game over, ${v.name} wins!`,document.querySelector(".reset-btn").classList.remove("hidden")},L=()=>{const e=a.board.getRemainingFreeCells();return e[Math.floor(Math.random()*e.length)]},E=(e,t=null)=>{let r;const o=parseInt(e);if("vertical"===t){if(r=function(e){let t=[];switch(!0){case 0===e:case 9===e:case 90===e:case 99===e:t="none";break;case u.includes(e):case s.includes(e):t=[e-10,e+10];break;case c.includes(e):case d.includes(e):t="none";break;default:t=[e-10,e+10]}return t}(o),"none"===r)return}else if("horizontal"===t){if(r=function(e){let t=[];switch(!0){case 0===e:case 9===e:case 90===e:case 99===e:t="none";break;case c.includes(e):case d.includes(e):t=[e-1,e+1];break;case u.includes(e):case s.includes(e):t="none";break;default:t=[e-1,e+1]}return t}(o),"none"===r)return}else r=function(e){let t=[];switch(!0){case 0===e:t=[e+1,e+10];break;case 9===e:t=[e-1,e+10];break;case 90===e:t=[e+1,e-10];break;case 99===e:t=[e-1,e-10];break;case u.includes(e):t=[e+1,e-10,e+10];break;case s.includes(e):t=[e-1,e-10,e+10];break;case c.includes(e):t=[e-1,e+1,e+10];break;case d.includes(e):t=[e-1,e+1,e-10];break;default:t=[e-1,e+1,e-10,e+10]}return t}(o);const n=function(e,t){return e.filter((e=>!t.includes(e)))}(r,a.board.getAllAttackedCoordinates());return n[Math.floor(Math.random()*n.length)]};function k(){let e=L(),t=[];const r=[];let n=null;document.querySelector(".board__table-2").addEventListener("click",(i=>{i.target.parentNode.parentNode.parentNode.classList.contains("board__table--active")&&new Promise((e=>{const t=o.board.receiveAttack(parseInt(i.target.dataset.coordinate));0===t.length?(l(i.target,!1),document.querySelector(".game-status").textContent="The battle is on!"):(l(i.target,!0),t[0].isSunk()&&(document.querySelector(".game-status").textContent=`You sunk one of ${o.name}'s ships!`)),e()})).then((()=>{if(w(o))throw q(),new Error("Game Over");f()})).then((()=>{let o;0!==t.length?r.length>1?"horizontal"===h(r)?(o=E(e,"horizontal"),void 0===o&&(o=E(r[0],"horizontal"))):(o=E(e,"vertical"),void 0===o&&(o=E(r[0],"vertical"))):o=E(e):0===t.length&&0!==r.length?r.length>1?"horizontal"===h(r)?(o=E(r[r.length-1],"horizontal"),void 0===o&&(o=E(r[0],"horizontal"))):(o=E(r[r.length-1],"vertical"),void 0===o&&(o=E(r[0],"vertical"))):(o=E(r[r.length-1]),void 0===o&&(o=E(r[0]))):o=L(),e=o,t=a.board.receiveAttack(parseInt(o)),null!==n&&0!==t.length&&t[0]!==n&&([n]=t,r.length=0),0!==t.length&&([n]=t),setTimeout((()=>{if(0===t.length?l(document.querySelector(`.board__table-1 [data-coordinate='${o}']`),!1):(l(document.querySelector(`.board__table-1 [data-coordinate='${o}']`),!0),t[0].isSunk()?(t.length=0,r.length=0,n=null):r.push(o)),w(a))throw q(),new Error("Game Over");f()}),500)})).catch((e=>{"Game Over"===e.message?console.log("TODO: game over logic"):console.log(e)}))}))}const O=e=>{e.target.parentNode.parentNode.parentNode.classList.contains("board__table--active")&&new Promise((t=>{0===a.board.receiveAttack(parseInt(e.target.dataset.coordinate)).length?l(e.target,!1):l(e.target,!0),t()})).then((()=>{w(a)?q():(f(),setTimeout((()=>i(document.querySelector(".board-one"),document.querySelector(".board-two"))),1e3))})).catch((e=>console.log(e)))},M=e=>{e.target.parentNode.parentNode.parentNode.classList.contains("board__table--active")&&new Promise((t=>{0===o.board.receiveAttack(parseInt(e.target.dataset.coordinate)).length?l(e.target,!1):l(e.target,!0),t()})).then((()=>{w(o)?q():(f(),setTimeout((()=>i(document.querySelector(".board-two"),document.querySelector(".board-one"))),1e3))})).catch((e=>console.log(e)))};return{playerOne:a,playerTwo:o,currentTurn:p,changeTurn:m,resetTurn:b,gameStartOnePlayer:()=>{o.placeAIShips(),b(),g(),_(),S(),k()},gameStartTwoPlayer:()=>{b(),g(),_(),S(),document.querySelector(".board__table-1").addEventListener("click",O),document.querySelector(".board__table-2").addEventListener("click",M)},changeCurrentPlayer:g,turnComplete:f,onePlayerGameLoop:k}}("Player 1","Player 2");return document.querySelector(".reset-btn").classList.add("hidden"),e.playerOne.board.resetBoard(),e.playerTwo.board.resetBoard(),e.playerOne.allocateDOMBoard(document.querySelector(".board__table-1")),e.playerTwo.allocateDOMBoard(document.querySelector(".board__table-2")),e}();y.addEventListener("click",(()=>{if(1===p()){if(!_.playerOne.allShipsPlaced())throw g.textContent="All ships must be placed first!",new Error("Not all ships placed");document.querySelectorAll(".board__cell").forEach((e=>e.classList.add("board__cell--active"))),_.gameStartOnePlayer(),n(_.playerOne,1),document.querySelector(".play-btn").classList.add("hidden"),document.querySelector(".restart-btn").classList.remove("hidden"),document.querySelector(".shipyard").remove(),v.textContent="The battle is on!"}else if(!_.playerTwo.allShipsPlaced()||!_.playerOne.allShipsPlaced())throw g.textContent="All ships must be placed first!",new Error("Not all ships placed")})),o(),1===p()&&(b(_.playerOne),m(_.playerOne)),window.addEventListener("boardswitched",(()=>{b(_.playerTwo),m(_.playerTwo)})),window.addEventListener("begintwoplayer",(()=>{document.querySelectorAll(".board__cell").forEach((e=>e.classList.add("board__cell--active"))),_.gameStartTwoPlayer(),n(_.playerOne,1),n(_.playerTwo,2)})),document.querySelector(".num-players__btn").addEventListener("click",(()=>{document.querySelector(".modal").style.display="none",1===p()?document.querySelector(".board-two").classList.remove("board--hidden"):document.querySelector(".board-two").classList.add("board--hidden")})),document.querySelector(".name-one").addEventListener("input",(e=>{_.playerTwo.name=e.target.textContent})),document.querySelector(".name-two").addEventListener("input",(e=>{_.playerTwo.name=e.target.textContent})),document.querySelector(".restart-btn").addEventListener("click",(()=>{window.location.reload()})),document.querySelector(".reset-btn").addEventListener("click",(()=>{window.location.reload()}))})();